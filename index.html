<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº“å­˜é”€å”®ç®¡ç†ç³»ç»Ÿ</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --font-display: 'JetBrains Mono', monospace;
      --font-body: 'IBM Plex Sans', sans-serif;
      --color-void: #0a0a0a;
      --color-obsidian: #121212;
      --color-carbon: #1a1a1a;
      --color-graphite: #242424;
      --color-slate: #2e2e2e;
      --color-steel: #3a3a3a;
      --color-amber-500: #d97706;
      --color-amber-400: #f59e0b;
      --color-success: #22c55e;
      --color-danger: #ef4444;
      --color-info: #0ea5e9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-body); background: var(--color-obsidian); color: #e0e0e0; min-height: 100vh; }
    .navbar { background: var(--color-void); border-bottom: 2px solid var(--color-steel); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
    .nav-brand { font-family: var(--font-display); font-size: 1.25rem; color: var(--color-amber-400); font-weight: 600; }
    .nav-menu { display: flex; gap: 5px; }
    .nav-item { padding: 10px 20px; cursor: pointer; font-family: var(--font-display); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; color: #8a8a8a; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .nav-item:hover { color: #e0e0e0; background: var(--color-carbon); }
    .nav-item.active { color: var(--color-amber-400); border-bottom-color: var(--color-amber-400); }
    .main-content { padding: 80px 20px 20px; max-width: 1600px; margin: 0 auto; }
    .page { display: none; }
    .page.active { display: block; }
    .card { background: var(--color-carbon); border: 1px solid var(--color-steel); padding: 20px; position: relative; }
    .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--color-amber-500), transparent); }
    .card h2 { font-family: var(--font-display); font-size: 1rem; color: var(--color-amber-400); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-family: var(--font-display); font-size: 0.75rem; color: #8a8a8a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    input, select { width: 100%; padding: 10px; background: var(--color-void); border: 1px solid var(--color-steel); color: #e0e0e0; font-size: 0.875rem; }
    input:focus, select:focus { outline: none; border-color: var(--color-amber-400); }
    button { font-family: var(--font-display); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px 20px; background: var(--color-graphite); color: #e0e0e0; border: 1px solid var(--color-steel); cursor: pointer; transition: all 0.2s; }
    button:hover { background: var(--color-steel); border-color: var(--color-amber-400); }
    button.primary { background: var(--color-amber-500); border-color: var(--color-amber-400); color: var(--color-void); font-weight: 600; }
    button.primary:hover { background: var(--color-amber-400); }
    button.danger { background: var(--color-danger); border-color: var(--color-danger); color: white; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-steel); font-size: 0.875rem; }
    .data-table th { font-family: var(--font-display); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #8a8a8a; background: var(--color-void); }
    .stat-card { background: var(--color-carbon); border: 1px solid var(--color-steel); padding: 20px; text-align: center; }
    .stat-value { font-family: var(--font-display); font-size: 2.5rem; color: var(--color-amber-400); font-weight: 700; }
    .stat-label { font-size: 0.75rem; color: #8a8a8a; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--color-carbon); border: 1px solid var(--color-steel); }
    .toolbar-group { display: flex; gap: 10px; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: var(--color-carbon); border: 1px solid var(--color-steel); }
    .pos-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    .pos-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 600px; overflow-y: auto; }
    .pos-product-item { background: var(--color-graphite); border: 1px solid var(--color-steel); padding: 15px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .pos-product-item:hover { border-color: var(--color-amber-400); transform: translateY(-2px); }
    .pos-product-item .name { font-size: 0.875rem; margin-bottom: 5px; }
    .pos-product-item .price { font-family: var(--font-display); color: var(--color-amber-400); font-size: 1.25rem; }
    .pos-product-item .stock { font-size: 0.7rem; color: #8a8a8a; margin-top: 5px; }
    .pos-cart { background: var(--color-carbon); border: 1px solid var(--color-steel); padding: 20px; display: flex; flex-direction: column; }
    .cart-items { flex: 1; overflow-y: auto; margin-bottom: 15px; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--color-steel); }
    .cart-item-qty { font-family: var(--font-display); font-size: 1rem; min-width: 30px; text-align: center; }
    .cart-total { display: flex; justify-content: space-between; font-size: 1.5rem; font-family: var(--font-display); margin-bottom: 15px; }
    .cart-total .amount { color: var(--color-amber-400); }
    .change-calculator { background: var(--color-void); padding: 15px; margin-bottom: 15px; border: 1px solid var(--color-steel); }
    .change-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .change-row input { width: 120px; text-align: right; font-family: var(--font-display); font-size: 1.25rem; }
    .change-result { font-size: 1.5rem; font-family: var(--font-display); color: var(--color-success); text-align: right; margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--color-steel); }
    .message { padding: 12px 15px; margin: 10px 0; font-size: 0.875rem; border-left: 3px solid; }
    .message-success { background: rgba(34, 197, 94, 0.1); border-color: var(--color-success); color: var(--color-success); }
    .message-error { background: rgba(239, 68, 68, 0.1); border-color: var(--color-danger); color: var(--color-danger); }
    .filter-tags { display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-tag { padding: 5px 12px; background: var(--color-graphite); border: 1px solid var(--color-steel); font-size: 0.75rem; cursor: pointer; }
    .filter-tag.active { background: var(--color-amber-500); border-color: var(--color-amber-400); color: var(--color-void); }
    .chart-container { position: relative; height: 300px; margin: 20px 0; }
    .ranking-list { list-style: none; }
    .ranking-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--color-steel); }
    .ranking-number { font-family: var(--font-display); font-size: 1.25rem; width: 40px; color: var(--color-amber-400); }
    .ranking-info { flex: 1; }
    .ranking-amount { font-family: var(--font-display); font-size: 1.25rem; color: var(--color-amber-400); }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--color-carbon); border: 1px solid var(--color-steel); padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--color-steel); }
    .modal-title { font-family: var(--font-display); font-size: 1.25rem; color: var(--color-amber-400); }
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 1024px) { 
      .pos-container { grid-template-columns: 1fr; }
    }
    
    @media (max-width: 768px) {
      .navbar { height: 50px; padding: 0 10px; }
      .nav-brand { font-size: 0.9rem; }
      .nav-menu { gap: 2px; }
      .nav-item { padding: 8px 10px; font-size: 0.7rem; letter-spacing: 0; }
      .main-content { padding: 65px 10px 10px; }
      .grid { grid-template-columns: 1fr; gap: 10px; }
      .card { padding: 15px; }
      .stat-value { font-size: 1.8rem; }
      .pos-products { grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: none; }
      .pos-product-item { padding: 12px 8px; }
      .pos-product-item .name { font-size: 0.8rem; }
      .pos-product-item .price { font-size: 1rem; }
      .pos-cart { position: fixed; bottom: 0; left: 0; right: 0; max-height: 50vh; z-index: 100; padding: 15px; border-top: 2px solid var(--color-amber-500); }
      .cart-items { max-height: 150px; }
      .search-bar { flex-direction: column; gap: 8px; padding: 10px; }
      .search-bar input, .search-bar select { width: 100%; font-size: 16px; padding: 12px; }
      button { padding: 12px 20px; font-size: 0.85rem; min-height: 44px; }
      .toolbar { flex-direction: column; gap: 10px; padding: 10px; }
      .toolbar-group { width: 100%; flex-wrap: wrap; }
      .toolbar-group input, .toolbar-group select { flex: 1; min-width: 120px; }
      .change-row input { width: 100%; font-size: 1.5rem; padding: 15px; }
      .change-result { font-size: 1.8rem; }
      .data-table { font-size: 0.8rem; }
      .data-table th, .data-table td { padding: 8px; }
      .chart-container { height: 200px; }
      .modal-content { padding: 20px; width: 95%; }
      .form-group input, .form-group select { padding: 12px; font-size: 16px; }
    }
    
    /* æ•°å­—é”®ç›˜ä¼˜åŒ– */
    input[type="tel"], input[type="number"] {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    /* è§¦æ‘¸ä¼˜åŒ– */
    button, .pos-product-item, .nav-item {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">ğŸ“¦ åº“å­˜é”€å”®ç®¡ç†ç³»ç»Ÿ</div>
    <div class="nav-menu">
      <div class="nav-item active" data-page="sales">ğŸ’° é”€å”®æ”¶é“¶</div>
      <div class="nav-item" data-page="inventory">ğŸ“¦ åº“å­˜ç®¡ç†</div>
      <div class="nav-item" data-page="reports">ğŸ“Š æŠ¥è¡¨ç»Ÿè®¡</div>
    </div>
  </nav>

  <main class="main-content">
    <!-- é”€å”®æ”¶é“¶é¡µé¢ -->
    <div id="page-sales" class="page active">
      <div class="pos-container">
        <div>
          <!-- æ‰«ç æ·»åŠ åŒºåŸŸ -->
          <div class="search-bar" style="background: var(--color-void); border: 2px solid var(--color-amber-500);">
            <input type="text" id="barcode-input" placeholder="ğŸ“· æ‰«ææˆ–è¾“å…¥å•†å“æ¡ç /ç¼–å·..." style="font-size: 1.1rem; border-color: var(--color-amber-400);">
            <button class="primary" onclick="scanAndAdd()" style="padding: 10px 30px;">â• æ·»åŠ </button>
          </div>
          <div class="search-bar">
            <input type="text" id="pos-search" placeholder="ğŸ” æœç´¢äº§å“åç§°...">
            <select id="pos-category">
              <option value="">æ‰€æœ‰ç±»åˆ«</option>
              <option value="electronics">ç”µå­äº§å“</option>
              <option value="clothing">æœè£…</option>
              <option value="food">é£Ÿå“</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          <div class="pos-products" id="pos-products"></div>
        </div>
        <div class="pos-cart">
          <h2>ğŸ›’ è´­ç‰©è½¦</h2>
          <div class="cart-items" id="cart-items">
            <p style="text-align: center; color: #8a8a8a; padding: 40px 0;">è´­ç‰©è½¦ä¸ºç©º</p>
          </div>
          <div class="change-calculator">
            <div class="change-row">
              <label>åº”æ”¶é‡‘é¢:</label>
              <span id="receivable-amount" style="font-family: var(--font-display); font-size: 1.25rem; color: var(--color-amber-400);">Â¥0.00</span>
            </div>
            <div class="change-row">
              <label>å®æ”¶ç°é‡‘:</label>
              <input type="tel" id="cash-received" placeholder="0.00" inputmode="decimal" pattern="[0-9]*">
            </div>
            <div class="change-result">
              <span>æ‰¾é›¶: </span>
              <span id="change-amount">Â¥0.00</span>
            </div>
          </div>
          <button class="primary" style="width: 100%; padding: 15px; font-size: 1rem;" onclick="checkout()">âœ… ç¡®è®¤æ”¶é“¶</button>
          <button style="width: 100%; margin-top: 10px;" onclick="clearCart()">ğŸ—‘ï¸ æ¸…ç©ºè´­ç‰©è½¦</button>
        </div>
      </div>
    </div>

    <!-- åº“å­˜ç®¡ç†é¡µé¢ -->
    <div id="page-inventory" class="page">
      <div class="toolbar">
        <div class="toolbar-group">
          <button class="primary" onclick="showAddProductModal()">â• æ·»åŠ äº§å“</button>
          <button onclick="exportProducts()">ğŸ“¤ å¯¼å‡ºCSV</button>
          <button onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥CSV</button>
          <input type="file" id="import-file" style="display: none;" accept=".csv" onchange="importProducts(this)">
        </div>
        <div class="toolbar-group">
          <input type="text" id="inventory-search" placeholder="æœç´¢äº§å“..." style="width: 200px;">
          <select id="inventory-category" style="width: 150px;">
            <option value="">æ‰€æœ‰ç±»åˆ«</option>
            <option value="electronics">ç”µå­äº§å“</option>
            <option value="clothing">æœè£…</option>
            <option value="food">é£Ÿå“</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div class="card">
        <h2>äº§å“åº“å­˜åˆ—è¡¨</h2>
        <table class="data-table">
          <thead>
            <tr><th>äº§å“åç§°</th><th>ç±»åˆ«</th><th>ä»·æ ¼</th><th>åº“å­˜</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="inventory-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- æŠ¥è¡¨ç»Ÿè®¡é¡µé¢ -->
    <div id="page-reports" class="page">
      <div class="toolbar">
        <div class="toolbar-group filter-tags">
          <button class="filter-tag active" data-period="today">ä»Šæ—¥</button>
          <button class="filter-tag" data-period="week">æœ¬å‘¨</button>
          <button class="filter-tag" data-period="month">æœ¬æœˆ</button>
          <button class="filter-tag" data-period="year">æœ¬å¹´</button>
        </div>
        <div class="toolbar-group">
          <button onclick="exportReport()">ğŸ“Š å¯¼å‡ºæŠ¥è¡¨</button>
        </div>
      </div>
      <div class="grid">
        <div class="stat-card">
          <div class="stat-value" id="report-sales-count">0</div>
          <div class="stat-label">é”€å”®ç¬”æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="report-sales-amount">Â¥0</div>
          <div class="stat-label">é”€å”®é‡‘é¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="report-products-sold">0</div>
          <div class="stat-label">å”®å‡ºå•†å“</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="report-avg-order">Â¥0</div>
          <div class="stat-label">å¹³å‡å®¢å•ä»·</div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h2>ğŸ“ˆ é”€å”®è¶‹åŠ¿</h2>
          <div class="chart-container"><canvas id="salesTrendChart"></canvas></div>
        </div>
        <div class="card">
          <h2>ğŸ¥§ é”€å”®ç±»åˆ«å æ¯”</h2>
          <div class="chart-container"><canvas id="categoryChart"></canvas></div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h2>ğŸ† äº§å“é”€å”®æ’è¡Œ TOP 10</h2>
          <ul class="ranking-list" id="product-ranking"></ul>
        </div>
        <div class="card">
          <h2>ğŸ’° ç»è¥åˆ†æ</h2>
          <div style="padding: 20px;">
            <p style="margin-bottom: 15px;"><span style="color: #8a8a8a;">æœ€ä½³é”€å”®æ—¶æ®µ:</span> <span id="best-time" style="font-family: var(--font-display); color: var(--color-amber-400);">-</span></p>
            <p style="margin-bottom: 15px;"><span style="color: #8a8a8a;">æœ€ç•…é”€ç±»åˆ«:</span> <span id="top-category" style="font-family: var(--font-display); color: var(--color-amber-400);">-</span></p>
            <p><span style="color: #8a8a8a;">åº“å­˜é¢„è­¦:</span> <span id="stock-alert" style="font-family: var(--font-display); color: var(--color-danger);">0</span> ä¸ªäº§å“åº“å­˜ä¸è¶³</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal" id="add-product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">â• æ·»åŠ æ–°äº§å“</span>
        <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal()">&times;</span>
      </div>
      <form id="add-product-form">
        <div class="form-group">
          <label>äº§å“åç§°</label>
          <input type="text" id="new-product-name" required>
        </div>
        <div class="form-group">
          <label>äº§å“ä»·æ ¼ (Â¥)</label>
          <input type="tel" id="new-product-price" required inputmode="decimal" pattern="[0-9]*">
        </div>
        <div class="form-group">
          <label>åº“å­˜æ•°é‡</label>
          <input type="tel" id="new-product-stock" required inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="form-group">
          <label>äº§å“ç±»åˆ«</label>
          <select id="new-product-category" required>
            <option value="electronics">ç”µå­äº§å“</option>
            <option value="clothing">æœè£…</option>
            <option value="food">é£Ÿå“</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
        <button type="submit" class="primary" style="width: 100%;">ä¿å­˜äº§å“</button>
      </form>
    </div>
  </div>

  <div id="message-container" style="position: fixed; top: 70px; right: 20px; z-index: 3000;"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBwTQk__6EmUPBHYfAaH-m9M_4pjtTT8wc",
      authDomain: "huangqg2026-prod.firebaseapp.com",
      projectId: "huangqg2026-prod",
      storageBucket: "huangqg2026-prod.firebasestorage.app",
      messagingSenderId: "863965567836",
      appId: "1:863965567836:web:ced995cff4dff3dc09ff99"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let products = [], cart = [], orders = [], currentPeriod = 'today';
    let salesChart = null, categoryChart = null;
    const categoryNames = { electronics: 'ç”µå­äº§å“', clothing: 'æœè£…', food: 'é£Ÿå“', other: 'å…¶ä»–' };

    function showMessage(msg, type = 'success') {
      const div = document.createElement('div');
      div.className = `message message-${type}`;
      div.textContent = msg;
      document.getElementById('message-container').appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // é¡µé¢å¯¼èˆª
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        item.classList.add('active');
        document.getElementById('page-' + item.dataset.page).classList.add('active');
        if (item.dataset.page === 'reports') loadReports();
      });
    });

    // åŠ è½½æ•°æ®
    async function loadProducts() {
      const snapshot = await getDocs(collection(db, 'products'));
      products = [];
      snapshot.forEach(d => products.push({ id: d.id, ...d.data() }));
      renderPOSProducts();
      renderInventoryTable();
    }

    async function loadOrders() {
      const q = query(collection(db, 'orders'), orderBy('created_at', 'desc'));
      const snapshot = await getDocs(q);
      orders = [];
      snapshot.forEach(d => orders.push({ id: d.id, ...d.data() }));
    }

    // POSåŠŸèƒ½
    function renderPOSProducts(search = '', category = '') {
      const container = document.getElementById('pos-products');
      let filtered = products.filter(p => {
        const matchName = p.name.toLowerCase().includes(search.toLowerCase());
        const matchCat = !category || p.category === category;
        return matchName && matchCat && p.quantity > 0;
      });
      
      container.innerHTML = filtered.length ? filtered.map(p => `
        <div class="pos-product-item" onclick="addToCart('${p.id}')">
          <div class="name">${p.name}</div>
          <div class="price">Â¥${parseFloat(p.price).toFixed(2)}</div>
          <div class="stock">åº“å­˜: ${p.quantity}</div>
        </div>
      `).join('') : '<p style="text-align: center; color: #8a8a8a; grid-column: 1/-1;">æ²¡æœ‰æ‰¾åˆ°äº§å“</p>';
    }

    window.addToCart = function(pid) {
      const p = products.find(x => x.id === pid);
      if (!p) return;
      const item = cart.find(x => x.id === pid);
      if (item) {
        if (item.qty < p.quantity) item.qty++;
        else { showMessage('åº“å­˜ä¸è¶³', 'error'); return; }
      } else {
        cart.push({ id: pid, name: p.name, price: parseFloat(p.price), qty: 1, stock: p.quantity });
      }
      renderCart();
    };

    // æ‰«ç æ·»åŠ å•†å“
    window.scanAndAdd = function() {
      const code = document.getElementById('barcode-input').value.trim();
      if (!code) {
        showMessage('è¯·è¾“å…¥å•†å“æ¡ç æˆ–ç¼–å·', 'error');
        return;
      }
      
      // å°è¯•åŒ¹é…ï¼šäº§å“IDã€äº§å“åç§°ã€æˆ–è‡ªå®šä¹‰æ¡ç å­—æ®µ
      let product = products.find(p => p.id === code);
      if (!product) {
        product = products.find(p => p.name.toLowerCase() === code.toLowerCase());
      }
      if (!product && !isNaN(code)) {
        // å¦‚æœæ˜¯æ•°å­—ï¼Œå°è¯•æŒ‰ç´¢å¼•æŸ¥æ‰¾
        const index = parseInt(code) - 1;
        if (index >= 0 && index < products.length) {
          product = products[index];
        }
      }
      
      if (product) {
        if (product.quantity > 0) {
          addToCart(product.id);
          showMessage(`å·²æ·»åŠ : ${product.name}`);
          document.getElementById('barcode-input').value = '';
          document.getElementById('barcode-input').focus();
        } else {
          showMessage('è¯¥äº§å“åº“å­˜ä¸è¶³', 'error');
        }
      } else {
        showMessage('æœªæ‰¾åˆ°è¯¥å•†å“ï¼Œè¯·æ£€æŸ¥æ¡ç æˆ–ç¼–å·', 'error');
      }
    };
    
    // æ‰«ç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    document.getElementById('barcode-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        scanAndAdd();
      }
    });

    function renderCart() {
      const container = document.getElementById('cart-items');
      if (!cart.length) {
        container.innerHTML = '<p style="text-align: center; color: #8a8a8a; padding: 40px 0;">è´­ç‰©è½¦ä¸ºç©º</p>';
        updateTotal();
        return;
      }
      let total = 0;
      container.innerHTML = cart.map(item => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        return `<div class="cart-item">
          <div><div>${item.name}</div><div style="font-size: 0.75rem; color: #8a8a8a;">Â¥${item.price.toFixed(2)} Ã— ${item.qty}</div></div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="updateQty('${item.id}', -1)" style="padding: 5px 10px;">-</button>
            <span class="cart-item-qty">${item.qty}</span>
            <button onclick="updateQty('${item.id}', 1)" style="padding: 5px 10px;">+</button>
            <button onclick="removeFromCart('${item.id}')" class="danger" style="padding: 5px 10px;">Ã—</button>
          </div>
        </div>`;
      }).join('');
      updateTotal(total);
    }

    function updateTotal(total = 0) {
      document.getElementById('receivable-amount').textContent = 'Â¥' + total.toFixed(2);
      calculateChange();
    }

    window.updateQty = function(pid, delta) {
      const item = cart.find(x => x.id === pid);
      if (!item) return;
      const newQty = item.qty + delta;
      if (newQty <= 0) removeFromCart(pid);
      else if (newQty > item.stock) showMessage('åº“å­˜ä¸è¶³', 'error');
      else { item.qty = newQty; renderCart(); }
    };

    window.removeFromCart = function(pid) {
      cart = cart.filter(x => x.id !== pid);
      renderCart();
    };

    window.clearCart = function() {
      cart = [];
      document.getElementById('cash-received').value = '';
      renderCart();
    };

    function calculateChange() {
      const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);
      const received = parseFloat(document.getElementById('cash-received').value) || 0;
      const change = received - total;
      document.getElementById('change-amount').textContent = 'Â¥' + (change >= 0 ? change.toFixed(2) : '0.00');
      document.getElementById('change-amount').style.color = change >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
    }

    document.getElementById('cash-received').addEventListener('input', calculateChange);

    window.checkout = async function() {
      if (!cart.length) { showMessage('è´­ç‰©è½¦ä¸ºç©º', 'error'); return; }
      const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);
      const received = parseFloat(document.getElementById('cash-received').value) || 0;
      if (received < total) { showMessage('å®æ”¶é‡‘é¢ä¸è¶³', 'error'); return; }
      
      try {
        for (const item of cart) {
          await addDoc(collection(db, 'orders'), {
            product_id: item.id, product_name: item.name, quantity: item.qty,
            unit_price: item.price, total_amount: item.price * item.qty,
            cash_received: received, change: received - total,
            created_at: serverTimestamp()
          });
          await updateDoc(doc(db, 'products', item.id), { quantity: item.stock - item.qty });
        }
        showMessage(`æ”¶é“¶æˆåŠŸï¼æ‰¾é›¶: Â¥${(received - total).toFixed(2)}`);
        clearCart();
        loadProducts();
      } catch (e) { showMessage('æ”¶é“¶å¤±è´¥: ' + e.message, 'error'); }
    };

    // æœç´¢ç­›é€‰
    document.getElementById('pos-search').addEventListener('input', e => renderPOSProducts(e.target.value, document.getElementById('pos-category').value));
    document.getElementById('pos-category').addEventListener('change', e => renderPOSProducts(document.getElementById('pos-search').value, e.target.value));
    document.getElementById('inventory-search').addEventListener('input', renderInventoryTable);
    document.getElementById('inventory-category').addEventListener('change', renderInventoryTable);

    // åº“å­˜ç®¡ç†
    function renderInventoryTable() {
      const search = document.getElementById('inventory-search').value.toLowerCase();
      const cat = document.getElementById('inventory-category').value;
      let filtered = products.filter(p => p.name.toLowerCase().includes(search) && (!cat || p.category === cat));
      const tbody = document.getElementById('inventory-table-body');
      tbody.innerHTML = filtered.length ? filtered.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${categoryNames[p.category] || p.category}</td>
          <td>Â¥${parseFloat(p.price).toFixed(2)}</td>
          <td style="color: ${p.quantity < 10 ? 'var(--color-danger)' : 'inherit'}">${p.quantity}</td>
          <td>
            <button onclick="deleteProduct('${p.id}')" class="danger" style="padding: 5px 10px;">åˆ é™¤</button>
          </td>
        </tr>
      `).join('') : '<tr><td colspan="5" style="text-align: center; color: #8a8a8a;">æ²¡æœ‰æ‰¾åˆ°äº§å“</td></tr>';
    }

    window.showAddProductModal = function() { document.getElementById('add-product-modal').classList.add('active'); };
    window.closeModal = function() { document.getElementById('add-product-modal').classList.remove('active'); };

    document.getElementById('add-product-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        await addDoc(collection(db, 'products'), {
          name: document.getElementById('new-product-name').value,
          price: parseFloat(document.getElementById('new-product-price').value),
          quantity: parseInt(document.getElementById('new-product-stock').value),
          category: document.getElementById('new-product-category').value,
          created_at: serverTimestamp()
        });
        showMessage('äº§å“æ·»åŠ æˆåŠŸï¼');
        closeModal();
        e.target.reset();
        loadProducts();
      } catch (err) { showMessage('æ·»åŠ å¤±è´¥: ' + err.message, 'error'); }
    });

    window.deleteProduct = async function(pid) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤äº§å“ï¼Ÿ')) return;
      try { await deleteDoc(doc(db, 'products', pid)); showMessage('äº§å“å·²åˆ é™¤'); loadProducts(); }
      catch (err) { showMessage('åˆ é™¤å¤±è´¥: ' + err.message, 'error'); }
    };

    // å¯¼å…¥å¯¼å‡º
    window.exportProducts = function() {
      const csv = 'åç§°,ç±»åˆ«,ä»·æ ¼,åº“å­˜\n' + products.map(p => `${p.name},${p.category},${p.price},${p.quantity}`).join('\n');
      downloadFile(csv, 'products.csv', 'text/csv');
      showMessage('äº§å“æ•°æ®å·²å¯¼å‡º');
    };

    window.importProducts = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        const lines = e.target.result.split('\n').slice(1);
        let count = 0;
        for (const line of lines) {
          const [name, cat, price, qty] = line.split(',');
          if (name && price && qty) {
            await addDoc(collection(db, 'products'), { name: name.trim(), category: cat?.trim() || 'other', price: parseFloat(price), quantity: parseInt(qty), created_at: serverTimestamp() });
            count++;
          }
        }
        showMessage(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªäº§å“`);
        loadProducts();
      };
      reader.readAsText(file);
      input.value = '';
    };

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // æŠ¥è¡¨
    document.querySelectorAll('.filter-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        currentPeriod = tag.dataset.period;
        loadReports();
      });
    });

    async function loadReports() {
      await loadOrders();
      const now = new Date();
      let start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (currentPeriod === 'week') start = new Date(now - 7 * 86400000);
      else if (currentPeriod === 'month') start = new Date(now.getFullYear(), now.getMonth(), 1);
      else if (currentPeriod === 'year') start = new Date(now.getFullYear(), 0, 1);

      const filtered = orders.filter(o => o.created_at?.toDate() >= start);
      const totalSales = filtered.reduce((sum, o) => sum + (o.total_amount || 0), 0);
      const totalQty = filtered.reduce((sum, o) => sum + (o.quantity || 0), 0);

      document.getElementById('report-sales-count').textContent = filtered.length;
      document.getElementById('report-sales-amount').textContent = 'Â¥' + totalSales.toFixed(0);
      document.getElementById('report-products-sold').textContent = totalQty;
      document.getElementById('report-avg-order').textContent = 'Â¥' + (filtered.length ? (totalSales / filtered.length).toFixed(0) : 0);

      updateCharts(filtered);
      updateRanking(filtered);
      
      const lowStock = products.filter(p => p.quantity < 10).length;
      document.getElementById('stock-alert').textContent = lowStock;
    }

    function updateCharts(data) {
      const daily = {};
      data.forEach(o => { const d = o.created_at?.toDate().toLocaleDateString(); if (d) daily[d] = (daily[d] || 0) + o.total_amount; });
      
      if (salesChart) salesChart.destroy();
      salesChart = new Chart(document.getElementById('salesTrendChart'), {
        type: 'line',
        data: { labels: Object.keys(daily).slice(-10), datasets: [{ data: Object.values(daily).slice(-10), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#8a8a8a' }, grid: { color: '#3a3a3a' } }, x: { ticks: { color: '#8a8a8a' }, grid: { color: '#3a3a3a' } } } }
      });

      const cats = {};
      data.forEach(o => { const c = o.product_name || 'å…¶ä»–'; cats[c] = (cats[c] || 0) + o.total_amount; });
      if (categoryChart) categoryChart.destroy();
      categoryChart = new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: { labels: Object.keys(cats).slice(0, 5), datasets: [{ data: Object.values(cats).slice(0, 5), backgroundColor: ['#f59e0b', '#22c55e', '#0ea5e9', '#ef4444', '#8b5cf6'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#e0e0e0' } } } }
      });
    }

    function updateRanking(data) {
      const sales = {};
      data.forEach(o => {
        const n = o.product_name || 'æœªçŸ¥';
        if (!sales[n]) sales[n] = { name: n, qty: 0, amt: 0 };
        sales[n].qty += o.quantity || 0;
        sales[n].amt += o.total_amount || 0;
      });
      const sorted = Object.values(sales).sort((a, b) => b.amt - a.amt).slice(0, 10);
      document.getElementById('product-ranking').innerHTML = sorted.map((p, i) => `
        <li class="ranking-item">
          <span class="ranking-number">${i + 1}</span>
          <div class="ranking-info"><div>${p.name}</div><div style="font-size: 0.75rem; color: #8a8a8a;">é”€é‡: ${p.qty} ä»¶</div></div>
          <span class="ranking-amount">Â¥${p.amt.toFixed(0)}</span>
        </li>
      `).join('');
    }

    window.exportReport = function() {
      const csv = 'æ—¶é—´,äº§å“,æ•°é‡,å•ä»·,æ€»é¢\n' + orders.map(o => [o.created_at?.toDate().toLocaleString(), o.product_name, o.quantity, o.unit_price, o.total_amount].join(',')).join('\n');
      downloadFile(csv, 'sales_report.csv', 'text/csv');
      showMessage('æŠ¥è¡¨å·²å¯¼å‡º');
    };

    // åˆå§‹åŒ–
    loadProducts();
    loadOrders();
  </script>
</body>
</html>
